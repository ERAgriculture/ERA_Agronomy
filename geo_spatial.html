<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alliance of Bioversity International &amp; CIAT">

<title>Geospatial Data in ERA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="geo_spatial_files/libs/clipboard/clipboard.min.js"></script>
<script src="geo_spatial_files/libs/quarto-html/quarto.js"></script>
<script src="geo_spatial_files/libs/quarto-html/popper.min.js"></script>
<script src="geo_spatial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="geo_spatial_files/libs/quarto-html/anchor.min.js"></script>
<link href="geo_spatial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="geo_spatial_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="geo_spatial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="geo_spatial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="geo_spatial_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#era-geospatial-data-and-climate-enrichment" id="toc-era-geospatial-data-and-climate-enrichment" class="nav-link active" data-scroll-target="#era-geospatial-data-and-climate-enrichment"><span class="header-section-number">1</span> ERA Geospatial Data and Climate Enrichment</a>
  <ul>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources"><span class="header-section-number">1.1</span> Data Sources</a>
  <ul class="collapse">
  <li><a href="#chirps-rainfall" id="toc-chirps-rainfall" class="nav-link" data-scroll-target="#chirps-rainfall"><span class="header-section-number">1.1.1</span> CHIRPS (Rainfall)</a></li>
  <li><a href="#power-nasa" id="toc-power-nasa" class="nav-link" data-scroll-target="#power-nasa"><span class="header-section-number">1.1.2</span> POWER (NASA)</a></li>
  <li><a href="#soilgrids-isric" id="toc-soilgrids-isric" class="nav-link" data-scroll-target="#soilgrids-isric"><span class="header-section-number">1.1.3</span> SoilGrids (ISRIC)</a></li>
  <li><a href="#aez-agro-ecological-zones" id="toc-aez-agro-ecological-zones" class="nav-link" data-scroll-target="#aez-agro-ecological-zones"><span class="header-section-number">1.1.4</span> AEZ (Agro-Ecological Zones)</a></li>
  <li><a href="#elevation-dem" id="toc-elevation-dem" class="nav-link" data-scroll-target="#elevation-dem"><span class="header-section-number">1.1.5</span> Elevation (DEM)</a></li>
  <li><a href="#water-balance-onset-of-rain" id="toc-water-balance-onset-of-rain" class="nav-link" data-scroll-target="#water-balance-onset-of-rain"><span class="header-section-number">1.1.6</span> Water Balance &amp; Onset of Rain</a></li>
  </ul></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods"><span class="header-section-number">1.2</span> Methods</a></li>
  <li><a href="#downloading-the-climate-data" id="toc-downloading-the-climate-data" class="nav-link" data-scroll-target="#downloading-the-climate-data"><span class="header-section-number">1.3</span> Downloading the climate data</a></li>
  <li><a href="#climate-data-content-and-structure" id="toc-climate-data-content-and-structure" class="nav-link" data-scroll-target="#climate-data-content-and-structure"><span class="header-section-number">1.4</span> Climate data content and structure</a>
  <ul class="collapse">
  <li><a href="#unique-locations-and-times-clim_datasite_data" id="toc-unique-locations-and-times-clim_datasite_data" class="nav-link" data-scroll-target="#unique-locations-and-times-clim_datasite_data"><span class="header-section-number">1.4.1</span> Unique locations and times (<code>clim_data$site_data</code>)</a>
  <ul class="collapse">
  <li><a href="#site-year-season-study" id="toc-site-year-season-study" class="nav-link" data-scroll-target="#site-year-season-study"><span class="header-section-number">1.4.1.1</span> Site, year, season, &amp; study</a></li>
  <li><a href="#crops" id="toc-crops" class="nav-link" data-scroll-target="#crops"><span class="header-section-number">1.4.1.2</span> Crops</a></li>
  <li><a href="#planting-dates" id="toc-planting-dates" class="nav-link" data-scroll-target="#planting-dates"><span class="header-section-number">1.4.1.3</span> Planting dates</a></li>
  <li><a href="#season-length" id="toc-season-length" class="nav-link" data-scroll-target="#season-length"><span class="header-section-number">1.4.1.4</span> Season length</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#output-and-linkage-to-era-observations" id="toc-output-and-linkage-to-era-observations" class="nav-link" data-scroll-target="#output-and-linkage-to-era-observations"><span class="header-section-number">1.5</span> Output and Linkage to ERA Observations</a></li>
  <li><a href="#dataset-versioning" id="toc-dataset-versioning" class="nav-link" data-scroll-target="#dataset-versioning"><span class="header-section-number">1.6</span> Dataset Versioning</a>
  <ul class="collapse">
  <li><a href="#dataset-integrity-is-maintained-via" id="toc-dataset-integrity-is-maintained-via" class="nav-link" data-scroll-target="#dataset-integrity-is-maintained-via"><span class="header-section-number">1.6.0.1</span> • Dataset integrity is maintained via:</a></li>
  <li><a href="#update-logic-is-script-based" id="toc-update-logic-is-script-based" class="nav-link" data-scroll-target="#update-logic-is-script-based"><span class="header-section-number">1.6.0.2</span> • Update logic is script-based:</a></li>
  <li><a href="#dataset-specific-versioning-examples" id="toc-dataset-specific-versioning-examples" class="nav-link" data-scroll-target="#dataset-specific-versioning-examples"><span class="header-section-number">1.6.0.3</span> • Dataset-specific versioning examples:</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Geospatial Data in ERA</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alliance of Bioversity International &amp; CIAT </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: pacman</code></pre>
</div>
</div>
<section id="era-geospatial-data-and-climate-enrichment" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> ERA Geospatial Data and Climate Enrichment</h1>
<section id="data-sources" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="data-sources"><span class="header-section-number">1.1</span> Data Sources</h2>
<p>The ERA pipeline enriches observations with climate, soil, and landscape data using custom functions stored in:</p>
<ul>
<li><a href="https://github.com/CIAT/ERA_dev/tree/main/R/add_geodata"><code>R/add_geodata/</code></a>: main dataset scripts</li>
<li><a href="https://github.com/CIAT/ERA_dev/tree/main/R/add_geodata/functions"><code>R/add_geodata/functions/</code></a>: core download and utility functions</li>
</ul>
<p>Below are the datasets used and the script locations.</p>
<hr>
<section id="chirps-rainfall" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="chirps-rainfall"><span class="header-section-number">1.1.1</span> CHIRPS (Rainfall)</h3>
<ul>
<li><strong>Dataset</strong>: CHIRPS Daily Rainfall</li>
<li><strong>Resolution</strong>: 0.05° (~5.5 km)</li>
<li><strong>Coverage</strong>: Africa and globally, 1981–present</li>
<li><strong>Download Source</strong>:<br>
<a href="https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/tifs/p05/"><code>https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/tifs/p05/</code></a></li>
<li><strong>Download Script</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/chirps.R"><code>R/add_geodata/chirps.R</code></a></li>
<li><strong>Download Function</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_chirps.R"><code>R/add_geodata/functions/download_chirps.R</code></a><br>
→ <code>download_chirps()</code></li>
<li><strong>Notes</strong>: Filenames include the date (e.g.&nbsp;<code>chirps.2023.01.01.tif.gz</code>). Versioning is inferred from file date.</li>
</ul>
<hr>
</section>
<section id="power-nasa" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="power-nasa"><span class="header-section-number">1.1.2</span> POWER (NASA)</h3>
<ul>
<li><strong>Dataset</strong>: NASA POWER (Temperature, Radiation, Wind, etc.)</li>
<li><strong>Resolution</strong>: 0.5° lat × 0.625° lon</li>
<li><strong>Coverage</strong>: ~1983–present</li>
<li><strong>Download Source</strong>:<br>
NASA POWER API — <code>https://power.larc.nasa.gov/api/temporal/daily/</code></li>
<li><strong>Download Script</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/power.R"><code>R/add_geodata/power.R</code></a></li>
<li><strong>Download Function</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_power.R"><code>R/add_geodata/functions/download_power.R</code></a><br>
→ <code>download_power()</code></li>
<li><strong>Notes</strong>: Parameters include <code>"T2M"</code>, <code>"PRECTOTCORR"</code>, etc. Metadata includes <code>"Site.Key"</code> and <code>"Altitude"</code> for site-matching.</li>
</ul>
<hr>
</section>
<section id="soilgrids-isric" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="soilgrids-isric"><span class="header-section-number">1.1.3</span> SoilGrids (ISRIC)</h3>
<ul>
<li><strong>Dataset</strong>: SoilGrids 2.0</li>
<li><strong>Resolution</strong>:
<ul>
<li><strong>Africa</strong>: 250 m<br>
</li>
<li><strong>Non-Africa</strong>: 1 km (as returned by <code>fetchSoilGrids()</code> API)</li>
</ul></li>
<li><strong>Coverage</strong>: Global</li>
<li><strong>Download Script</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/soilgrids.R"><code>R/add_geodata/soilgrids.R</code></a><br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/soilgrids2.R"><code>R/add_geodata/soilgrids2.R</code></a></li>
<li><strong>Download Function</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_soilgrids2.R"><code>R/add_geodata/functions/download_soilgrids2.R</code></a><br>
→ <code>download_soilgrids_data()</code>, <code>attempt_fetch()</code></li>
<li><strong>Notes</strong>: Internally calls <code>soilDB::fetchSoilGrids()</code>; output is reshaped and saved as CSV per site/variable.</li>
</ul>
<hr>
</section>
<section id="aez-agro-ecological-zones" class="level3" data-number="1.1.4">
<h3 data-number="1.1.4" class="anchored" data-anchor-id="aez-agro-ecological-zones"><span class="header-section-number">1.1.4</span> AEZ (Agro-Ecological Zones)</h3>
<ul>
<li><strong>Layers Used</strong>:
<ul>
<li><code>AEZ16_CLAS--SSA.tif</code>: from Harvard Dataverse<br>
</li>
<li><code>004_afr-aez_09.tif</code>: from <a href="https://files.africasis.isric.org/aez/004_afr-aez_09.tif">ISRIC server</a></li>
</ul></li>
<li><strong>Script</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/aez.R"><code>R/add_geodata/aez.R</code></a></li>
<li><strong>Notes</strong>: The ISRIC AEZ layer is recoded with value-to-label mappings from a CSV.</li>
</ul>
<hr>
</section>
<section id="elevation-dem" class="level3" data-number="1.1.5">
<h3 data-number="1.1.5" class="anchored" data-anchor-id="elevation-dem"><span class="header-section-number">1.1.5</span> Elevation (DEM)</h3>
<ul>
<li><strong>Dataset</strong>: Elevation raster</li>
<li><strong>Download Script</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/elevation.R"><code>R/add_geodata/elevation.R</code></a></li>
<li><strong>Notes</strong>: Processed from SRTM or other public sources.</li>
</ul>
<hr>
</section>
<section id="water-balance-onset-of-rain" class="level3" data-number="1.1.6">
<h3 data-number="1.1.6" class="anchored" data-anchor-id="water-balance-onset-of-rain"><span class="header-section-number">1.1.6</span> Water Balance &amp; Onset of Rain</h3>
<ul>
<li><strong>Water Balance</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/water_balance.R"><code>R/add_geodata/water_balance.R</code></a><br>
→ PET, ETo, Rain - PET</li>
<li><strong>Onset Date (Start of Season)</strong>:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/calculate_sos.R"><code>R/add_geodata/calculate_sos.R</code></a></li>
</ul>
<hr>
</section>
</section>
<section id="methods" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="methods"><span class="header-section-number">1.2</span> Methods</h2>
<p>The <code>generate_climate_stats.R</code> pipeline defines observation windows using:</p>
<ul>
<li>Explicit planting/harvest dates from the ERA observation (<code>obs_table</code>)</li>
<li>Imputed planting date logic when missing</li>
<li>Option to use fixed season windows or growing-period-specific logic (e.g., 90 days before harvest)</li>
</ul>
<hr>
</section>
<section id="downloading-the-climate-data" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="downloading-the-climate-data"><span class="header-section-number">1.3</span> Downloading the climate data</h2>
<p>To access the climate statistics used in ERA, download the harmonized <code>.RData</code> file from the geodata directory on S3:</p>
<ul>
<li><strong>S3 location</strong>: <code>s3://digital-atlas/era/geodata/clim_stats_2025-03-18.RData</code></li>
<li><strong>Content</strong>: This file contains daily and seasonal climate summaries per site, ready to be joined with ERA observations.</li>
</ul>
<p>You can download the file using the <code>s3fs</code> interface as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"s3fs"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>s3<span class="ot">&lt;-</span>s3fs<span class="sc">::</span>S3FileSystem<span class="sc">$</span><span class="fu">new</span>(<span class="at">anonymous =</span> T)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the remote S3 path and local save path</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>s3_data_dir <span class="ot">&lt;-</span> <span class="st">"s3://digital-atlas/era/geodata"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>local_data_dir <span class="ot">&lt;-</span> <span class="st">"data"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># List and filter files</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>files_s3 <span class="ot">&lt;-</span> s3<span class="sc">$</span><span class="fu">dir_ls</span>(s3_data_dir)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>files_s3 <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"clim_stats"</span>, files_s3, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>(files_s3 <span class="ot">&lt;-</span> <span class="fu">tail</span>(files_s3, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "s3://digital-atlas/era/geodata/clim_stats_2025-03-18.RData"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create local file path and download</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>files_local <span class="ot">&lt;-</span> <span class="fu">gsub</span>(s3_data_dir, local_data_dir, files_s3)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(files_local)){</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>s3<span class="sc">$</span><span class="fu">file_download</span>(files_s3, files_local)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once downloaded, load the .RData file using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the harmonized climate data into your environment</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>clim_data <span class="ot">&lt;-</span> miceadds<span class="sc">::</span><span class="fu">load.Rdata2</span>(<span class="at">file =</span> <span class="fu">basename</span>(files_local), <span class="at">path =</span> <span class="fu">dirname</span>(files_local))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="climate-data-content-and-structure" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="climate-data-content-and-structure"><span class="header-section-number">1.4</span> Climate data content and structure</h2>
<p><code>clim_dat</code> is a named list of data tables, created by <code>generate_climate_stats.R</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(clim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PDate.SLen.Data"    "PDate.SLen.EcoCrop" "PDate.SLen.P30"    
[4] "site_data"         </code></pre>
</div>
</div>
<section id="unique-locations-and-times-clim_datasite_data" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="unique-locations-and-times-clim_datasite_data"><span class="header-section-number">1.4.1</span> Unique locations and times (<code>clim_data$site_data</code>)</h3>
<p><code>site_data</code> contains the unique combinations of site, time, crop, planting date, and harvest date from the ERA agronomy dataset.</p>
<section id="site-year-season-study" class="level4" data-number="1.4.1.1">
<h4 data-number="1.4.1.1" class="anchored" data-anchor-id="site-year-season-study"><span class="header-section-number">1.4.1.1</span> Site, year, season, &amp; study</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">unique</span>(clim_data<span class="sc">$</span>site_data[,.(Site.Key,Code,M.Year,Latitude,Longitude,M.Year,M.Year.Code,M.Season)]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Site.Key     Code M.Year Latitude Longitude M.Year M.Year.Code
                  &lt;char&gt;   &lt;char&gt; &lt;char&gt;    &lt;num&gt;     &lt;num&gt; &lt;char&gt;      &lt;char&gt;
1: 11.1555 -12.5285 B400   NN0002   2007  11.1555  -12.5285   2007        &lt;NA&gt;
2:  13.2790 -5.9340 B600   NN0002   2007  13.2790   -5.9340   2007        &lt;NA&gt;
3:  10.3671 -9.3355 B500   NN0002   2007  10.3671   -9.3355   2007        &lt;NA&gt;
4:  13.2790 -5.9340 B600   NN0003   1998  13.2790   -5.9340   1998        &lt;NA&gt;
5:  33.8430 -5.4760 B500   NN0008   1994  33.8430   -5.4760   1994        &lt;NA&gt;
6: 32.9540 -7.6260 B1000 NN0009.1   1995  32.9540   -7.6260   1995        &lt;NA&gt;
   M.Season
     &lt;char&gt;
1:     &lt;NA&gt;
2:     &lt;NA&gt;
3:     &lt;NA&gt;
4:     &lt;NA&gt;
5:     &lt;NA&gt;
6:     &lt;NA&gt;</code></pre>
</div>
</div>
<p><strong>Field Descriptions:</strong> - <strong>Site.Key</strong>: A unique identifier for each site or location. It is used to link locations consistently across datasets. - <strong>Code</strong>: A unique code used to identify a publication or entry in the ERA dataset. It serves as the main key for tracking a specific experiment/publication across associated tables. - <strong>M.Year</strong>: Measurement year – a code that identifies the production season, typically aligned with the <code>Time</code> field in the main ERA dataset. This may take the form of a calendar year or include other formatting to distinguish multiple seasons per year. - <strong>Latitude</strong>: Geographic latitude of the site in decimal degrees (WGS84). Used for spatial analyses and mapping. - <strong>Longitude</strong>: Geographic longitude of the site in decimal degrees (WGS84). Used for spatial analyses and mapping. - <strong>M.Year.Code</strong>: A standardized or formatted version of <code>M.Year</code>, often combining year and season. Useful for indexing and subsetting. - <strong>M.Season</strong>: Management season (typically <code>1</code> or <code>2</code>) indicating the cropping season within a year. May be <code>NA</code> in unimodal systems; helps distinguish multiple cropping events in bimodal climates.</p>
</section>
<section id="crops" class="level4" data-number="1.4.1.2">
<h4 data-number="1.4.1.2" class="anchored" data-anchor-id="crops"><span class="header-section-number">1.4.1.2</span> Crops</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">unique</span>(clim_data<span class="sc">$</span>site_data[,.(Product,EU,Topt.low,Topt.high,Tlow,Thigh)]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Product     EU Topt.low Topt.high  Tlow Thigh
                &lt;char&gt; &lt;char&gt;    &lt;num&gt;     &lt;num&gt; &lt;num&gt; &lt;num&gt;
1:               Fonio     c6     24.2      31.4  11.4  36.8
2:        Pearl Millet    c17     25.0      35.0  12.0  40.0
3:             Sorghum    c13     22.0      35.0   8.0  40.0
4:               Wheat    c14     15.0      23.0   5.0  27.0
5: Groundnut or Peanut     h9     22.0      32.0  10.0  45.0
6:               Maize     c7     18.0      33.0  10.0  47.0</code></pre>
</div>
</div>
<p><strong>Field Descriptions:</strong> - <strong>Product</strong>: The name of the crop or agricultural product (e.g., maize, beans) associated with the management and outcome data. - <strong>EU</strong>: Experimental Unit code links to the <code>era_master_codes$EU</code> table. - <strong>Tlow</strong>: The <strong>minimum temperature threshold</strong> for crop development. Below this value, crop growth is assumed to be negligible or halted. Often derived from EcoCrop or agronomic sources. - <strong>Thigh</strong>: The <strong>maximum temperature threshold</strong> for crop development. Temperatures above this can lead to heat stress or failure in development. - <strong>Topt.low</strong>: The <strong>lower bound of the optimal temperature range</strong> for crop growth. Within this and <code>Topt.high</code>, the crop achieves near-optimal physiological performance. - <strong>Topt.high</strong>: The <strong>upper bound of the optimal temperature range</strong> for crop growth. Growth efficiency typically declines beyond this value, even if not fully stressed.</p>
<p>These thresholds define a crop’s temperature response curve and come from EcoCrop. They can also be used to calculate growing degree days, stress indices, or suitability zones under historical or future climate conditions.</p>
</section>
<section id="planting-dates" class="level4" data-number="1.4.1.3">
<h4 data-number="1.4.1.3" class="anchored" data-anchor-id="planting-dates"><span class="header-section-number">1.4.1.3</span> Planting dates</h4>
<p><code>site_data</code> contains information about planting dates and their estimation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(clim_data<span class="sc">$</span>site_data[,.(Plant.Start,Plant.End,Plant.Diff.Raw,Data.PS.Date,Data.PE.Date,SOS,P.Date.Merge,P.Date.Merge.Source,PlantingDate)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Plant.Start  Plant.End Plant.Diff.Raw Data.PS.Date Data.PE.Date    SOS
        &lt;Date&gt;     &lt;Date&gt;          &lt;int&gt;       &lt;Date&gt;       &lt;Date&gt; &lt;Date&gt;
1:  2007-07-13 2007-07-13              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
2:  2007-07-12 2007-07-12              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
3:  2007-07-09 2007-07-09              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
4:  1998-07-23 1998-07-23              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
5:  1998-07-13 1998-07-13              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
6:  1993-12-07 1993-12-07              0         &lt;NA&gt;         &lt;NA&gt;   &lt;NA&gt;
   P.Date.Merge P.Date.Merge.Source PlantingDate
          &lt;num&gt;              &lt;char&gt;       &lt;Date&gt;
1:        13707           Published   2007-07-13
2:        13706           Published   2007-07-12
3:        13703           Published   2007-07-09
4:        10430           Published   1998-07-23
5:        10420           Published   1998-07-13
6:         8741           Published   1993-12-07</code></pre>
</div>
</div>
<p><strong>Field Descriptions:</strong></p>
<ul>
<li><strong>Plant.Start</strong>: The reported start date for planting. This indicates when the planting period began according to the original data.</li>
<li><strong>Plant.End</strong>: The reported end date for planting. This marks the conclusion of the planting period in the original dataset.</li>
<li><strong>Plant.Diff.Raw</strong>: The difference (in days) between <code>Plant.Start</code> and <code>Plant.End</code>—indicating how uncertain the reported planting window was.</li>
<li><strong>Data.PS.Date</strong>: The estimated start date for planting, inferred from nearby or similar observations in ERA when a reported planting date is missing or uncertain.</li>
<li><strong>Data.PE.Date</strong>: The estimated end date for planting, derived using the same method as Data.PS.Date to define a plausible planting window.</li>
<li><strong>SOS</strong>: The estimated Start of Season date, derived from daily climate data using agroclimatic thresholds (e.g.&nbsp;rainfall ≥25 mm in a dekad and ≥20 mm in the following two dekads, with aridity index AI ≥ 0.5). It marks when planting conditions were first met based on climatic signals.</li>
<li><strong>P.Date.Merge</strong>: The final, merged planting date calculated by the pipeline. It represents a consolidated planting date that may incorporate adjustments or estimations (for example, averaging the planting window or refining it using rainfall data). It should be interpreted as the number of days since <code>1900-01-01</code>.</li>
<li><strong>P.Date.Merge.Source</strong>: A descriptive label indicating the source or method used to derive the merged planting date. This might indicate whether the date was taken directly from published data (e.g., “Published”) or estimated using spatial or rainfall data (e.g., “Nearby 1km”, “SOS + Published”, etc.).</li>
<li><strong>PlantingDate</strong>:</li>
</ul>
<p>Explanation of <code>P.Date.Merge.Source</code> values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>clim_data<span class="sc">$</span>site_data[,<span class="fu">unique</span>(P.Date.Merge.Source)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Published"              "Published CHIRPS"       "Nearby 10km"           
[4] "Nearby 10km CHIRPS"     "Nearby 1km CHIRPS"      "SOS + Published CHIRPS"
[7] "Nearby 1km"             "SOS + Published"       </code></pre>
</div>
</div>
<p>Values below are presented in order of preference when estimating planting date in the <code>P.Date.Merge</code> field - <strong>Published</strong>: The planting date was directly reported in the original study with no need for estimation.<br>
- <strong>Published CHIRPS</strong>: A published planting date was available but was refined or verified using CHIRPS rainfall data.<br>
- <strong>Nearby 1km CHIRPS</strong> : The estimation was based on observations from locations within a 1‑km radius, with additional refinement using CHIRPS data.<br>
- <strong>Nearby 10km CHIRPS</strong>: As with the 10‑km estimation, this method further incorporated CHIRPS rainfall data to improve the estimate.<br>
- <strong>Nearby 1km</strong>: Similar to the CHIRPS-based 1‑km estimate but without the additional rainfall data refinement.<br>
- <strong>Nearby 10km</strong>: The planting date was estimated from nearby observations aggregated over a 10‑km radius due to missing or uncertain reported dates.<br>
- <strong>SOS + Published</strong>: The planting date was adjusted using SOS information in cases where the published date was uncertain, without incorporating CHIRPS data.<br>
- <strong>SOS + Published CHIRPS</strong>: When the reported planting date (Published) was too uncertain, the method adjusted it using the Start‐of‐Season (SOS) rainfall onset data alongside CHIRPS information.</p>
<p>This hierarchy reflects a logical preference: <strong>Directly observed data &gt; Nearby analogues &gt; Climatological estimation</strong>.</p>
</section>
<section id="season-length" class="level4" data-number="1.4.1.4">
<h4 data-number="1.4.1.4" class="anchored" data-anchor-id="season-length"><span class="header-section-number">1.4.1.4</span> Season length</h4>
<p><code>site_data</code> contains information about reported harvest dates and season length, the latter may use the reported data or be estimated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(clim_data<span class="sc">$</span>site_data[,.(Harvest.Start,Harvest.End,SLen,Data.SLen,SLen.EcoCrop,SLen.Source,SeasonLength.Data,SeasonLength.EcoCrop)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Harvest.Start Harvest.End  SLen Data.SLen SLen.EcoCrop     SLen.Source
          &lt;Date&gt;      &lt;Date&gt; &lt;num&gt;     &lt;num&gt;        &lt;num&gt;          &lt;char&gt;
1:    2007-10-15  2007-10-15  94.0        NA           65 Published + Pub
2:    2007-10-24  2007-10-24 104.0        NA           65 Published + Pub
3:    2007-10-06  2007-10-07  89.5        NA           65 Published + Pub
4:    1998-11-16  1998-11-16 116.0        NA          105 Published + Pub
5:    1998-11-03  1998-11-03 113.0        NA          115 Published + Pub
6:    1994-05-28  1994-05-28 172.0        NA          151 Published + Pub
   SeasonLength.Data SeasonLength.EcoCrop
               &lt;num&gt;                &lt;num&gt;
1:              94.0                   65
2:             104.0                   65
3:              89.5                   65
4:             116.0                  105
5:             113.0                  115
6:             172.0                  151</code></pre>
</div>
</div>
<p><strong>Field Descriptions:</strong></p>
<ul>
<li><strong>Harvest.Start</strong>: The reported or estimated date when harvest began. Typically reflects the first day of the harvest window.</li>
<li><strong>Harvest.End</strong>: The reported or estimated date when harvest concluded. Typically reflects the last day of the harvest window.</li>
<li><strong>SLen</strong>: Season Length – calculated as the number of days between <code>Plant.Start</code> and <code>Harvest.End</code>. Represents the observed or estimated duration of the cropping cycle.</li>
<li><strong>Data.SLen</strong>: Season Length derived from reported data only (i.e., <code>Plant.Start</code> and <code>Harvest.End</code> must both be available from original records). Used to indicate where the season length is based on direct evidence rather than estimates.</li>
<li><strong>SLen.EcoCrop</strong>: An estimate of cropping cycle length derived from the EcoCrop database refined using data available in ERA where possible. Used as a fallback when data-derived values are missing. <code>SeasonLength.EcoCrop</code> is redundant and contains the same information as <code>SLen.EcoCrop</code>.</li>
<li><strong>SLen.Source</strong>: This field indicates how the final <strong>Season Length</strong> (<code>SeasonLength.Data</code> field) used in calculations was derived, based on the origin of planting and harvest date estimates. The format is:<code>&lt;Planting Source&gt; + &lt;Season Length Source&gt;</code>.</li>
<li><strong>SeasonLength.Data</strong>: Combines <code>SLen</code> and <code>Data.SLen</code> fields, substituting values <code>Data.SLen</code> when <code>SLen</code> is <code>NA.</code></li>
</ul>
<p>Explanation of SLen.Source values: ::: {.cell}</p>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>clim_data<span class="sc">$</span>site_data[,<span class="fu">unique</span>(SLen.Source)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Published + Pub"              "Published + Nearby 1km"      
 [3] "CHIRPS Published + Pub"       NA                            
 [5] "Nearby 1km + Nearby 1km"      "Nearby 1km + Nearby 10km"    
 [7] "SOS + Published + Nearby 1km" "CHIRPS SOS + Published + Pub"
 [9] "Published + Nearby 10km"      "Nearby 1km + Pub"            
[11] "Nearby 10km + Nearby 1km"    </code></pre>
</div>
<p>:::</p>
<p>The format of <code>SLen.Source</code> is <code>&lt;Planting Source&gt; + &lt;Season Length Source&gt;</code> and the order of preference for the season length source is the same as for planting. Observed values include:<br>
- <strong>Published + Pub</strong> – Both planting and harvest dates are reported with low uncertainty in the publication.<br>
- <strong>Published + Nearby 1km</strong> – Planting date reported with low uncertainty; season length estimated from nearby (within 1 km) observations.<br>
- <strong>CHIRPS Published + Pub</strong> – Planting date reported, but uncertain, and refined using CHIRPS rainfall; harvest dates reported with low uncertainty.<br>
- <strong>Nearby 1km + Nearby 1km</strong> – Both planting date and season length derived from nearby (within 1 km) observations.<br>
- <strong>Nearby 1km + Nearby 10km</strong> – Planting date from 1 km radius; season length from 10 km radius.<br>
- <strong>SOS + Published + Nearby 1km</strong> –The planting date was adjusted using SOS information in cases where the published date was uncertain, without incorporating CHIRPS data; season length from nearby data.<br>
- <strong>CHIRPS SOS + Published + Pub</strong> – When the reported planting date (Published) was too uncertain, the method adjusted it using the Start‐of‐Season (SOS) rainfall onset data alongside CHIRPS information; harvest dates reported with low uncertainty.<br>
- <strong>Published + Nearby 10km</strong> – Planting date reported with low uncertainty; season length from 10 km proximity.<br>
- <strong>Nearby 1km + Pub</strong> – Planting data from nearby; harvest dates reported with low uncertainty.<br>
- <strong>Nearby 10km + Nearby 1km</strong> – Planting data from nearby;season length from 10 km proximity.<br>
- <strong>NA</strong> – No season length estimate was available or derived.</p>
<p>These combinations trace the logical fallback and merging sequence for generating season length when direct data are missing or uncertain.</p>
</section>
</section>
</section>
<section id="output-and-linkage-to-era-observations" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="output-and-linkage-to-era-observations"><span class="header-section-number">1.5</span> Output and Linkage to ERA Observations</h2>
<p>These can be merged with ERA observation data using the Site.ID and Time fields.</p>
<p>You can link this to ERA using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Merge climate stats to agronomic observations</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#obs &lt;- fread("path/to/era_observations.csv")</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#clim &lt;- readRDS("path/to/clim_stats_2025-03-18.RData")</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#obs_clim &lt;- merge(obs, clim, by = "Site.ID", all.x = TRxUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dataset-versioning" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="dataset-versioning"><span class="header-section-number">1.6</span> Dataset Versioning</h2>
<p>ERA does not use hardcoded version numbers in the metadata. Instead:</p>
<section id="dataset-integrity-is-maintained-via" class="level4" data-number="1.6.0.1">
<h4 data-number="1.6.0.1" class="anchored" data-anchor-id="dataset-integrity-is-maintained-via"><span class="header-section-number">1.6.0.1</span> • Dataset integrity is maintained via:</h4>
<ul>
<li><strong>Source URLs</strong> and mirrors embedded in scripts<br>
</li>
<li><strong>Filename conventions</strong><br>
e.g., <code>chirps.2023.01.01.tif.gz</code> for CHIRPS data<br>
</li>
<li><strong>Timestamps in output object names</strong><br>
e.g., <code>clim_stats_2025-03-18.RData</code></li>
</ul>
</section>
<section id="update-logic-is-script-based" class="level4" data-number="1.6.0.2">
<h4 data-number="1.6.0.2" class="anchored" data-anchor-id="update-logic-is-script-based"><span class="header-section-number">1.6.0.2</span> • Update logic is script-based:</h4>
<ul>
<li>Most downloader scripts accept <code>update = TRUE</code> to force re-download.</li>
</ul>
</section>
<section id="dataset-specific-versioning-examples" class="level4" data-number="1.6.0.3">
<h4 data-number="1.6.0.3" class="anchored" data-anchor-id="dataset-specific-versioning-examples"><span class="header-section-number">1.6.0.3</span> • Dataset-specific versioning examples:</h4>
<ul>
<li><p><strong>CHIRPS</strong>:<br>
Downloaded directly from <a href="https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/tifs/p05/">CHC UCSB FTP</a><br>
Files stored as <code>.tif.gz</code> and organized by year<br>
Script: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/chirps.R"><code>R/add_geodata/chirps.R</code></a><br>
Function: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_chirps.R"><code>download_chirps()</code></a></p></li>
<li><p><strong>POWER</strong>:<br>
Accessed via NASA POWER API (<code>daily</code>, <code>ag</code> community)<br>
Script: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/power.R"><code>R/add_geodata/power.R</code></a><br>
Function: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_power.R"><code>download_power()</code></a></p></li>
<li><p><strong>SoilGrids</strong>:<br>
Africa sites use 250 m resolution<br>
Global sites use ~1 km resolution based on API response<br>
Scripts:<br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/soilgrids.R"><code>R/add_geodata/soilgrids.R</code></a><br>
<a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/soilgrids2.R"><code>R/add_geodata/soilgrids2.R</code></a><br>
Function: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/functions/download_soilgrids2.R"><code>download_soilgrids_data()</code></a></p></li>
<li><p><strong>AEZ (Agro-Ecological Zones)</strong>:</p>
<ul>
<li><code>AEZ16_CLAS--SSA.tif</code> from Harvard Dataverse<br>
</li>
<li><code>004_afr-aez_09.tif</code> from ISRIC (recoded via CSV mapping)<br>
Script: <a href="https://github.com/CIAT/ERA_dev/blob/main/R/add_geodata/aez.R"><code>R/add_geodata/aez.R</code></a></li>
</ul></li>
</ul>
<p>All scripts are version-controlled and maintained in the <a href="https://github.com/CIAT/ERA_dev">CIAT/ERA_dev GitHub repository</a>.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>